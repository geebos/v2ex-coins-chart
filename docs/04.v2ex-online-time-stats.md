## 1. 需求概述

实现V2EX网站用户在线时间统计功能，通过监听用户鼠标移动事件来判断用户活跃状态，配合防抖函数控制统计频率，将在线时间数据按照用户、年、月的维度进行存储，每个月份记录该月所有小时粒度的时间戳列表，并提供多种查询分析功能，帮助用户了解自己的V2EX使用习惯。

## 2. 功能点拆分与依赖

| 功能点序号 | 功能点名称 | 功能点描述 | 前置依赖 |
|------------|------------|------------|----------|
| 1          | 基础存储结构设计 | 设计以用户、年、月为key的存储结构，value为该月所有小时粒度的时间记录列表，支持在线时间数据的高效存储和查询 | 无       |
| 2          | 鼠标移动事件监听 | 在V2EX页面的body元素上添加onmove事件监听器，用于检测用户活跃状态 | 无        |
| 3          | Debounce防抖函数实现 | 实现5分钟间隔的防抖函数，避免频繁触发在线时间统计，优化性能 | 无        |
| 4          | 消息通信机制 | 建立content script与background script之间的消息传递机制，用于传递在线时间统计信号 | 1        |
| 5          | 在线时间计算与存储 | background script接收到活跃信号后，将用户在线时间增加5分钟并存储到对应的时间维度key中 | 1, 4        |
| 6          | 时间段查询接口 | 提供查询指定时间段内总在线时间的接口，支持按日、周、月、年等维度查询 | 1, 5        |
| 7          | 在线时间分布查询 | 提供查询在线时间在不同时间段内分布情况的接口，如每小时、每天的在线时长分布 | 1, 5        |
| 8          | 在线时间同比查询 | 提供同比分析功能，支持查询当前时间段与历史同期时间段的在线时间对比数据 | 1, 5        |

## 3. 详细功能说明

### 3.1 基础存储结构设计
- **存储key格式**: `onlineTime:{username}:{year}:{month}`
- **存储value**: 该月所有小时的在线时间记录列表，每个元素包含小时时间戳（毫秒）和对应的在线时间（分钟数）
- **value结构**: `[{timestamp: 1705298400000, minutes: 30}, {timestamp: 1705302000000, minutes: 25}, ...]`
- **示例**: `onlineTime:user123:2024:01` 存储用户user123在2024年1月的所有小时粒度在线时间记录

### 3.2 鼠标移动事件监听
- **事件绑定**: `document.body.addEventListener('mousemove', debouncedHandler)`
- **触发条件**: 用户在页面上移动鼠标
- **处理逻辑**: 触发防抖函数，避免过于频繁的处理

### 3.3 Debounce防抖函数实现
- **防抖间隔**: 5分钟（300000毫秒）
- **功能**: 确保在5分钟内多次鼠标移动只触发一次统计
- **实现**: 使用setTimeout实现标准防抖逻辑

### 3.4 消息通信机制
- **发送方**: content script
- **接收方**: background script  
- **消息格式**: `{type: 'USER_ACTIVE', timestamp: Date.now(), username: string}`
- **通信方式**: chrome.runtime.sendMessage

### 3.5 在线时间计算与存储
- **计算逻辑**: 每次收到USER_ACTIVE消息，读取用户对应月份的在线时间记录列表，查找或创建对应小时的记录，将该小时的在线时间增加5分钟
- **存储更新**: 读取当前月份的记录列表，更新对应小时的数据后，重新存储整个列表
- **时间处理**: 根据消息timestamp确定对应的年月，以及具体的小时时间戳（毫秒时间戳，精确到小时的开始时间）
- **数据结构**: 列表中不存在对应小时记录时创建新记录 `{timestamp: 1705298400000, minutes: 5}`，存在时累加分钟数

### 3.6 查询接口功能
- **时间段查询**: `getOnlineTimeByRange(username, startTime, endTime)` 
- **分布查询**: `getOnlineTimeDistribution(username, startTime, endTime, granularity)`
- **同比查询**: `getOnlineTimeComparison(username, currentPeriod, previousPeriod)`

## 4. 验收标准

- [x] 用户在V2EX页面移动鼠标后，5分钟内再次移动不会重复统计
- [x] 在线时间数据能够正确按照用户、年、月维度存储，每月包含小时粒度的时间戳记录列表
- [x] 能够查询指定时间段内的总在线时间
- [x] 能够查询在线时间的分布情况（如每小时分布）
- [x] 能够进行同比分析，对比不同时期的在线时间
- [x] 页面刷新或重新打开后，事件监听能够正常工作
- [x] 存储的时间数据准确无误，无重复统计或遗漏 